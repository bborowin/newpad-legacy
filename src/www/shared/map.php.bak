<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<title>

<?php 
include 'qualifier.php';
include 'users.php';

$q = new Qualifier(true);

$city = $q->Get("city");
$mode = $q->Get("mode");
$s = new Sql($city);
$s_main = new Sql('main');
$u = new Users();
$userId = $u->GetUserId();
$maxHits = intval($u->GetDf($userId, "maxHits", "120"));
$lat = 0;
$lon = 0;
$min = 0;
$max = 0;
$radius = 0;
$run = 0;

//get user's last search details
$query = "SELECT lat, lon, radius, low, high FROM $city.Searches WHERE mode = $mode AND userId = $userId ORDER BY ts DESC LIMIT 1;";
$result = $s->GetTable($query);
if($result != null)
while ($row = $result->fetch ())
{
  $lat = $row['lat'];
  $lon = $row['lon'];
  $min = $row['low'];
  $max = $row['high'];
  $radius = $row['radius'];
}

if(0 == $radius)
{
  $zoom = 14;
}
else
{
  $zoom = floor(log(0.32 / $radius, 2) + 10);
  $run = 1;
}

$showAd = ('hide' != $u->Get($userId, "ads"));

//format and show title
echo ucfirst($city);
if (1==$mode) 
  echo ' Apartments';
else
  echo ' Roommates';
?>
</title>

<link href='http://fonts.googleapis.com/css?family=Ubuntu&subset=cyrillic,latin' rel='stylesheet' type='text/css' />
<?
$map_css = 'map' . (($showAd) ? '.css' : '_noads.css');
echo '<link href="' . $map_css . '?time=' . filemtime($map_css) . '" rel="stylesheet" type="text/css" />';
?>

<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>

<script type="text/javascript" src="util.js?time=<?php echo(filemtime("util.js")); ?>"></script>
<script type="text/javascript" src="markers.js?time=<?php echo(filemtime("markers.js")); ?>"></script>
<script type="text/javascript" src="init.js?time=<?php echo(filemtime("init.js")); ?>"></script>
</head>
<?php
$med = 0;
$std = 0;

//if the user had no previous searches, use city lat/lon
if(0 == $run)
{
  $result = $s_main->GetTable("SELECT lat, lon FROM Cities where name LIKE '$city';");
  if($result != null)
  while ($row = $result->fetch ())
  {
    $lat = $row['lat'];
    $lon = $row['lon'];
  }

  $query = "SELECT med, std FROM Updates u INNER JOIN Cities c on u.cityId = c.id WHERE u.mode = $mode AND c.name LIKE '$city';";
  $result = $s_main->GetTable($query);
  if($result != null)
  while ($row = $result->fetch ())
  {
    $med = $row['med'];
    $std = $row['std'];
  }
}

function PriceSlider($min, $max)
{
    $script = '<script type="text/javascript"> ';
    $script .= '$(function() {';
    $script .= '	$("#slider").slider({';
    $script .= '		range: true,';
    $script .= '		min: 250,';
    $script .= '		max: 2500,';
    $script .= '		step: 5,';
    $script .= '		values: [' . strval($min) . ', ' . strval($max) . '],';
    $script .= '		orientation: "vertical",';
    $script .= '		slide: function(event, ui) {';
    $script .= '			$("#amount").text("$" + ui.values[0] + " - $" + ui.values[1]);';
    $script .= '		}';
    $script .= '	});';
    $script .= '	$("#amount").text("$" + $("#slider").slider("values", 0) + " - $" + $("#slider").slider("values", 1));';
    $script .= '});';
    $script .= '</script> ';
    
    return $script;
}

function IntroPopup($city, $mode)
{
  $modeStr = (1 == $mode) ? "apartments" : "rooms";
  $val = "<div id='introDiv'>Click anywhere on the map to search for $modeStr in that area.</br></br> ";
  $val .= "Adjust your price range using the slider on the right.</br></br></br> ";
  $val .= "<span id=\"dismissDiv\" onclick=\"$(this).parent().hide();\" >Hide this message</span>";
  $val .= '<span id="disableIntroDiv" onclick="$.get(\'action.php\', { city:\'' . $city . '\', action:\'disableIntroDiv\'}); $(this).parent().hide();">Don\'t show again</span></div>';
  
  return $val;
}

function AdSense()
{
  echo '<div id="left" class="column adsense" style="width:160px; height:600px;"> ';
  echo '<script type="text/javascript"> ';
  echo 'google_ad_client = "ca-pub-7521172234820738"; ';
  echo 'google_ad_slot = "7235504003"; ';
  echo 'google_ad_width = 160; ';
  echo 'google_ad_height = 600; ';
  echo '</script> ';
  echo '<script type="text/javascript" ';
  echo 'src="http://pagead2.googlesyndication.com/pagead/show_ads.js"> ';
  echo '</script> ';
  echo '</div> ';
}


if(0 == $min && 0 == $max)
{
  $min = strval($med - 1 * $std);
  $max = strval($med + 1 * $std);
}
echo PriceSlider($min, $max);

if(!$u->Get($userId, "hideIntroDiv")) echo IntroPopup($city, $mode);

?>

<body onload="initialize(<? echo '\'' . $city . '\', ' . $mode . ', ' . $lat . ', ' . $lon . ', ' . $zoom . ', ' . '$(\'#slider\').slider(\'values\', 0), $(\'#slider\').slider(\'values\', 1), ' . $maxHits . ', ' . $run . ');';?>">

	<div id="container">

		<div id="map_canvas" class="column"></div>
    <div style="position:absolute; left:0px; bottom:1em; width:160px; text-align:center;"><a href="../privacy.html">privacy policy</a></div>
    <? if($showAd) echo AdSense(); ?>
	</div>
  
  <div id="prices"><div id="amount"></div></div>
  <div id="slider_container"><div id="slider" style="margin:0em; height:100%;"></div></div>
  <div title="Each dot marks one place. The size of the dot corresponds to the posting age, and the brightness of the colour corresponds to price. &#13;You can adjust the price range with the slider on the right side of the map. If you hold the mouse cursor over a dot, it will show a quick summary of the posting. Clicking the dot will let you see the original ad, as well as give you the option to mark it as a favourite." id="legendDiv"><img src="img/legend.png"></img></div>
  <div id='cpDiv'>Copyright 2010 Newpad.ca</div>

  <?
    if(!$u->Get($userId, "hideIntroDiv")) echo IntroPopup($city, $mode);
  ?>
</body>


</html>
    
